---
title: "Análise da base RAIS"
description: |
  Esta análise teve como objetivo analisar os salários na base da RAIS.
  
author:
  - name: Alan Santos
theme: semanadsp.css
date: "`r format(Sys.time(), '%d %b, %Y')`"
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Neste relatório estamos interessados em responder a pergunta:

"Quanto ganha um cientista de dados?"

Para isso, vamos utilizar a base da RAIS anonimazada

# Acessando os dados da RAIS

Vamos utilizar o [datalake da iniciativa base dos dados](https://basedosdados.org).

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(tidyverse)
```


Segue abaixo,  o código que carrega as primeiras 5 linhas da tabela de microdados

```{r}
# ler um arquivo
#tab_normal <- read.csv("https://raw.githubusercontent.com/curso-r/main-r4ds-1/master/dad#os/imdb.csv")

#head(tab_normal, n = 5)

```


```{r, cache=TRUE, eval = FALSE}

codigos_cbo <- c(
        "252515", "252525" , "211110",
        # pesquisa/cientista
        "211205", "411035",
        "211210", "131120", "211215"
        # ocupaçoes estatisticas
)

# usando SGDB (máquina - processa e envia os dados)
conexao <- dbConnect(
        bigquery(), 
        project = "basedosdados",
        dataset = "br_me_rais",
        billing = "semanads-337000"
)

# conexao simples entre o r e a tabela do google(robo)

bigrquery::bq_auth("alanferreirasantos37@gmail.com")

base_tbl <- tbl(conexao, "microdados_vinculos") %>% 
        select(everything()) %>% 
        filter(
                ano >= 2013 & cbo_2002 %in% c(codigos_cbo)
        ) 


tabela_microdados_vinculos <- collect(base_tbl)


readr::write_rds(tabela_microdados_vinculos, 
                 "tabela_microdados_vinculos.rds" ,compress = "xz")


 
```

A base de dados que queremos analisar aqui é a base de pessoas que (pontencialmente) trabalham com ciência de dados. Existe um código brasileiro de ocupações (CBO), que 
tem um cadastro de todas as ocupações formais do brasil. Vamos pegar alguns códigos que são relacionados a ciência de dados e filtrar a base da RAIS para obter os dados

Pergunta principal da pesquisa: 

> quanto uma pessoa que trabalha com ciência de dados ganha?

```{r}

#codigos_cbo <- c(
#        "252515", "252525" , "211110",
        # pesquisa/cientista
#        "211205", "411035",
#        "211210", "131120", "211215"
        # ocupaçoes estatisticas
#)


#microdados_tbl <- tbl(conexao, "microdados_vinculos") %>% 
#        select(everything()) %>% 
#        filter(
#                ano >= 2013 & cbo_2002 %in% c(codigos_cbo)
#        ) %>% 
#        head()

#tabela_microdados_vinculos <- collect(microdados_tbl)

#saveRDS(tabela_microdados_vinculos, "tabela_microdados_vinculos.rds")


```


## Perguntas

Quanto ganha uma pessoa que trabalha com ciência de dados?

Perguntas secundárias
- Quanto o valor varia (médio) no tempo?

- Quanto o valor varia por característica das pessoas
        - Gênero
        - etnia
        - idade
- [Desafio] Qual cargo tem a maior taxa de crescimento dentro daquele setor da economia (CNAE)
proporcionalmente a municipios com mais pessoas empregadas naquela CBO.

Como variam os salários médios no tempo?

```{r}

tabela_microdados_vinculos <- readRDS("tabela_microdados_vinculos.rds")

library(ggplot2)

tabela_medias <- tabela_microdados_vinculos %>% 
        group_by(ano) %>% 
        summarise(media_salario = mean(valor_remuneracao_media))

ggplot(tabela_medias) +
        aes(x = ano, y = media_salario) +
        geom_col() +
        scale_x_continuous(breaks = 2013:2019) +
        ggthemes::theme_fivethirtyeight()
        
```


Agora vamos ver os números exatos:

```{r}

library(knitr)

tabela_medias %>% 
        kable()
        
```



### Quanto o valor varia regionalmente?

```{r}

tabela_media_uf <- tabela_microdados_vinculos %>% 
        group_by(sigla_uf) %>% 
        summarise(
                media_uf = mean(valor_remuneracao_media)
        )

```

Esta visualizacao a principio é melhor em tabela:

```{r}

knitr::kable(tabela_media_uf)
```

Agora em graficos

```{r}

tabela_media_uf %>% 
        ggplot(aes(x = sigla_uf, y = media_uf))

```

Esse gráfico é legal até para colocar na análise explicativa! DF e RJ estão muito acima dos outros estados, conforme destacado no gráfico abaixo:

```{r}

library(forcats)

tabela_media_uf %>%
        mutate(
               sigla_uf = fct_reorder(sigla_uf, media_uf) 
        ) %>% 
        ggplot(aes(y = sigla_uf, x = media_uf)) +
        geom_col() +
        labs(
                y = "Unidade da Federação",
                x = "Média Salarial (R$)"
        )+
        ggthemes::theme_fivethirtyeight()

```

Será que essa mesma conclusão permanece quando escolhemos a mediana como medida
resumo dos salários?

```{r}

library(forcats)

tabela_mediana_uf <- tabela_microdados_vinculos %>%
        group_by(sigla_uf) %>% 
        summarise(
                mediana_uf = median(valor_remuneracao_media)
        )


tabela_mediana_uf %>% 
        arrange(desc(mediana_uf)) %>% 
        knitr::kable()
  
```



```{r}


tabela_mediana_uf %>%  
      mutate(
               sigla_uf = fct_reorder(sigla_uf, mediana_uf) 
        ) %>% 
        ggplot(aes(y = sigla_uf, x = mediana_uf)) +
        geom_col() +
        labs(
                y = "Unidade da Federação",
                x = "Média Salarial (R$)"
        )+
        ggthemes::theme_fivethirtyeight()


```

### Os salários variam por sexo?

```{r}

tabela_resumo_sexo <- tabela_microdados_vinculos %>% 
        group_by(sexo) %>% 
        summarise(
                media = mean(valor_remuneracao_media),
                mediana = median(valor_remuneracao_media)
        )

tabela_resumo_sexo %>% 
        knitr::kable()

```

### Os salários variam por etnia?

```{r}

tabela_resumo_raca_cor <- tabela_microdados_vinculos %>% 
        group_by(raca_cor) %>% 
        summarise(
                media = mean(valor_remuneracao_media),
                mediana = median(valor_remuneracao_media)
        )

tabela_resumo_raca_cor %>% 
        knitr::kable()
```


### Tabela resumo por sexo, raça e cor

```{r}

tabela_resumo_sexo_raca_cor <- tabela_microdados_vinculos %>% 
        group_by(sexo, raca_cor) %>%
        summarise(
                media = mean(valor_remuneracao_media),
                mediana = median(valor_remuneracao_media)
        )

tabela_resumo_sexo_raca_cor %>% 
        knitr::kable()
        

```

```{r}

ggplot(tabela_resumo_sexo_raca_cor,
       aes(x = raca_cor, y = media, fill = sexo)) +
        geom_col(position = "dodge") +
        labs(
                x = "Raça e Cor",
                y = "Salário Médio em Reais (R$)"
        ) +
        ggthemes::theme_fivethirtyeight()

```


## Regressão linear

```{r}

lm(valor_remuneracao_media ~ sexo, data = tabela_microdados_vinculos)

lm(valor_remuneracao_media ~ sexo + raca_cor, data = tabela_microdados_vinculos)

```


## Regressão linear múltipla

```{r}



```



### Qual é a diferença dos salários da base?

```{r}

tabela_microdados_vinculos %>% 
        filter(valor_remuneracao_media > 0) %>% 
        ggplot(aes(x = log(valor_remuneracao_media))) +
        geom_histogram() +
        facet_wrap(~ cbo_2002)

```

